# Render deployment file â€” Phase 6 verified
version: "1"
services:
  # --- APP SERVICE ---
  - type: web
    name: sara-ai-core-app
    runtime: docker
    repo: https://github.com/artisticmonarchs/Sara-ai-core
    plan: standard
    region: ohio
    dockerContext: .
    dockerfilePath: ./Dockerfile
    autoDeployTrigger: commit
    healthCheckPath: /health
    dockerCommand: gunicorn -k uvicorn.workers.UvicornWorker app:app --chdir /app --bind 0.0.0.0:$PORT
    envVars:
      - key: REDIS_URL
        fromService:
          name: sara-ai-core-redis
          type: keyvalue
          property: connectionString
      - key: OPENAI_API_KEY
        sync: false
      - key: ELEVENLABS_API_KEY
        sync: false
      # (include your other existing env vars here)

  # --- WORKER SERVICE ---
  - type: web     # use "web" instead of "worker" to avoid Render's workdir issue
    name: sara-ai-core-worker
    runtime: docker
    repo: https://github.com/artisticmonarchs/Sara-ai-core
    plan: standard
    region: ohio
    dockerContext: .
    dockerfilePath: ./Dockerfile
    autoDeployTrigger: commit
    dockerCommand: celery -A celery_app.celery worker --loglevel=info
    envVars:
      - key: REDIS_URL
        fromService:
          name: sara-ai-core-redis
          type: keyvalue
          property: connectionString
      - key: OPENAI_API_KEY
        sync: false
      - key: ELEVENLABS_API_KEY
        sync: false
      # (same env vars as app)

  # --- STREAMING SERVICE ---
  - type: web
    name: sara-ai-core-streaming
    runtime: docker
    repo: https://github.com/artisticmonarchs/Sara-ai-core
    plan: standard
    region: ohio
    dockerContext: .
    dockerfilePath: ./Dockerfile
    autoDeployTrigger: commit
    dockerCommand: python -m streaming_server
    healthCheckPath: /healthz
    envVars:
      - key: REDIS_URL
        fromService:
          name: sara-ai-core-redis
          type: keyvalue
          property: connectionString
      # (same env vars as above)

  # --- REDIS SERVICE ---
  - type: keyvalue
    name: sara-ai-core-redis
    plan: starter
    region: ohio
    maxmemoryPolicy: allkeys-lru
