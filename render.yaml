# render.yaml — Sara AI Core (Phase 5B Final, verified)
# All Render services: Flask API, Celery Worker, Streaming Server, Redis

version: "1"

services:
  # --------------------------------------------------------
  # Flask API Service (Gunicorn + Uvicorn)
  # --------------------------------------------------------
  - type: web
    name: sara-ai-core-app
    env: python
    buildCommand: |
      pip install -r requirements.txt
    startCommand: |
      gunicorn -k uvicorn.workers.UvicornWorker sara_ai.app:app --bind 0.0.0.0:$PORT
    envVars:
      - key: REDIS_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_BROKER_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_RESULT_BACKEND
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/1
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PORT
        value: "10000"

  # --------------------------------------------------------
  # Celery Worker (background process — no port)
  # --------------------------------------------------------
  - type: worker
    name: sara-ai-core-worker
    env: python
    buildCommand: |
      pip install -r requirements.txt
    startCommand: |
      celery -A sara_ai.celery_app worker --loglevel=info
    envVars:
      - key: REDIS_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_BROKER_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_RESULT_BACKEND
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/1
      - key: PYTHONUNBUFFERED
        value: "1"

  # --------------------------------------------------------
  # Streaming Server (Flask or aiohttp WebSocket)
  # --------------------------------------------------------
  - type: web
    name: sara-ai-core-streaming
    env: python
    buildCommand: |
      pip install -r requirements.txt
    startCommand: |
      python -m sara_ai.streaming_server
    envVars:
      - key: REDIS_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_BROKER_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_RESULT_BACKEND
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/1
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PORT
        value: "10001"

# --------------------------------------------------------
# Redis datastore (shared broker/result backend)
# --------------------------------------------------------
databases:
  - name: sara-ai-redis
    plan: standard
    maxmemoryPolicy:
