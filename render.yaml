# render.yaml â€” Sara AI Core (Phase 12, Production)
# Matches existing services:
# - Web API:    Sara-ai-core-app        (Docker Web, Ohio)
# - Streaming:  Sara-ai-core-streaming  (Docker Web, Ohio)
# - Worker:     Sara-ai-core-worker     (Docker Worker, Ohio)
# - Redis:      Existing Valkey instance (internal URL provided below)

services:
  # 1) Web API (Flask/Gunicorn)
  - type: web
    name: Sara-ai-core-app
    env: docker
    region: ohio
    plan: standard
    autoDeploy: true
    runtime:
      dockerfilePath: ./Dockerfile
      dockerContext: .
      # Render UI currently sets this; mirroring here for IaC parity:
      dockerCommand: >-
        gunicorn app:app --workers 2 --threads 4 --bind 0.0.0.0:$PORT --timeout 120 --log-level info
    healthCheckPath: /healthz
    envVars:
      - key: ENV
        value: production
      - key: PORT
        value: "5000"
      # ---- Core secrets (set values in Render Dashboard) ----
      - key: OPENAI_API_KEY
        sync: false
      - key: DEEPGRAM_API_KEY
        sync: false
      - key: ELEVENLABS_API_KEY
        sync: false
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_CALLER_ID
        sync: false
      - key: TWILIO_MEDIA_STREAM_URL
        sync: false
      # ---- Redis / Celery (use your existing Valkey internal URL) ----
      - key: REDIS_URL
        value: "redis://red-d43ertemcj7s73b0qrcg:6379"
      - key: CELERY_BROKER_URL
        value: "redis://red-d43ertemcj7s73b0qrcg:6379/0"
      - key: CELERY_RESULT_BACKEND
        value: "redis://red-d43ertemcj7s73b0qrcg:6379/1"
      # ---- Cloudflare R2 ----
      - key: R2_ACCOUNT_ID
        sync: false
      - key: R2_ACCESS_KEY_ID
        sync: false
      - key: R2_SECRET_ACCESS_KEY
        sync: false
      - key: R2_BUCKET
        sync: false
      # ---- Observability ----
      - key: SENTRY_DSN
        sync: false
      - key: PROMETHEUS_PORT
        value: "9000"

  # 2) Streaming Web Service (Twilio Media Streams ingress)
  - type: web
    name: Sara-ai-core-streaming
    env: docker
    region: ohio
    plan: standard
    autoDeploy: true
    runtime:
      dockerfilePath: ./Dockerfile
      dockerContext: .
      dockerCommand: >-
        python -m streaming_server
    healthCheckPath: /healthz
    envVars:
      - key: ENV
        value: production
      - key: PORT
        value: "5000"
      # Core secrets needed by streaming path
      - key: OPENAI_API_KEY
        sync: false
      - key: DEEPGRAM_API_KEY
        sync: false
      - key: ELEVENLABS_API_KEY
        sync: false
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_CALLER_ID
        sync: false
      - key: TWILIO_MEDIA_STREAM_URL
        sync: false
      # Redis
      - key: REDIS_URL
        value: "redis://red-d43ertemcj7s73b0qrcg:6379"
      # Observability
      - key: SENTRY_DSN
        sync: false
      - key: PROMETHEUS_PORT
        value: "9000"

  # 3) Celery Worker
  - type: worker
    name: Sara-ai-core-worker
    env: docker
    region: ohio
    plan: standard
    autoDeploy: true
    runtime:
      dockerfilePath: ./Dockerfile
      dockerContext: .
      dockerCommand: >-
        celery -A celery_app.celery worker --loglevel=info --concurrency=1
    envVars:
      - key: ENV
        value: production
      # Broker/Backend via Valkey
      - key: REDIS_URL
        value: "redis://red-d43ertemcj7s73b0qrcg:6379"
      - key: CELERY_BROKER_URL
        value: "redis://red-d43ertemcj7s73b0qrcg:6379/0"
      - key: CELERY_RESULT_BACKEND
        value: "redis://red-d43ertemcj7s73b0qrcg:6379/1"
      # Secrets often needed by tasks
      - key: OPENAI_API_KEY
        sync: false
      - key: DEEPGRAM_API_KEY
        sync: false
      - key: ELEVENLABS_API_KEY
        sync: false
      - key: R2_ACCOUNT_ID
        sync: false
      - key: R2_ACCESS_KEY_ID
        sync: false
      - key: R2_SECRET_ACCESS_KEY
        sync: false
      - key: R2_BUCKET
        sync: false
      - key: SENTRY_DSN
        sync: false
      - key: PROMETHEUS_PORT
        value: "9000"
