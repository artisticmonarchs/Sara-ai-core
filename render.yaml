version: "1"

services:
  # --------------------------------------------------------
  # Main Application API (Flask + Uvicorn via Gunicorn)
  # --------------------------------------------------------
  - type: web
    name: sara-ai-core-app
    env: python
    plan: standard
    region: oregon
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn -k uvicorn.workers.UvicornWorker sara_ai.app:app --bind 0.0.0.0:$PORT
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: sara-ai-core-redis
          property: connectionString
      - key: WORKER_URL
        value: http://sara-ai-core-worker:10000
      - key: STREAM_URL
        value: http://sara-ai-core-streaming:10000

  # --------------------------------------------------------
  # Celery Background Worker (no exposed port)
  # --------------------------------------------------------
  - type: worker
    name: sara-ai-core-worker
    env: python
    plan: standard
    region: oregon
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A sara_ai.celery_app worker --loglevel=info
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: sara-ai-core-redis
          property: connectionString

  # --------------------------------------------------------
  # Streaming Server (WebSocket/Flask server)
  # --------------------------------------------------------
  - type: web
    name: sara-ai-core-streaming
    env: python
    plan: standard
    region: oregon
    buildCommand: pip install -r requirements.txt
    startCommand: python -m sara_ai.streaming_server
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: sara-ai-core-redis
          property: connectionString

# --------------------------------------------------------
# Redis Instance
# --------------------------------------------------------
databases:
  - name: sara-ai-core-redis
    plan: standard
    maxmemoryPolicy: allkeys-lru
