# render.yaml — Sara AI Core (Phase 5B)
# Defines all Render services for Sara AI backend deployment

version: "1"

services:
  # --------------------------------------------------------
  # 1️⃣ Main Application API
  # --------------------------------------------------------
  - type: web
    name: sara-ai-core-app
    env: python
    plan: standard
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn -k uvicorn.workers.UvicornWorker sara_ai.app:app --bind 0.0.0.0:$PORT --timeout 120
    envVars:
      - key: ENV
        value: production
      - key: REDIS_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_BROKER_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_RESULT_BACKEND
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/1

  # --------------------------------------------------------
  # 2️⃣ Celery Worker
  # --------------------------------------------------------
  - type: worker
    name: sara-ai-core-worker
    env: python
    plan: standard
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A sara_ai.celery_app worker --loglevel=info --pool=prefork --concurrency=2
    envVars:
      - key: ENV
        value: production
      - key: REDIS_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_BROKER_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_RESULT_BACKEND
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/1

  # --------------------------------------------------------
  # 3️⃣ Streaming Server (Twilio Gateway)
  # --------------------------------------------------------
  - type: web
    name: sara-ai-core-streaming
    env: python
    plan: standard
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn -k uvicorn.workers.UvicornWorker sara_ai.streaming_server:app --bind 0.0.0.0:$PORT --timeout 120
    envVars:
      - key: ENV
        value: production
      - key: REDIS_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_BROKER_URL
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/0
      - key: CELERY_RESULT_BACKEND
        value: redis://red-d3ip3vodl3ps73dd24o0:6379/1

# --------------------------------------------------------
# 4️⃣ Redis (Render Key-Value Store)
# --------------------------------------------------------
databases:
  - name: sara-ai-redis
    plan: standard
    ipAllowList: []
    maxmemoryPolicy: allkeys-lru
