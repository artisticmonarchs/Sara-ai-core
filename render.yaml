# --------------------------------------------------------
# render.yaml â€” Sara AI Core (Phase 5B, Final Fixed Version)
# Defines all 3 backend services + Redis for production deployment
# --------------------------------------------------------

version: "1"

services:
  # --------------------------------------------------------
  # Main Flask API (Gunicorn WSGI)
  # --------------------------------------------------------
  - type: web
    name: sara-ai-core-app
    env: python
    plan: standard
    region: oregon
    autoDeploy: true
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn sara_ai.app:app --bind 0.0.0.0:5000 --timeout 120
    healthCheckPath: /health

    envVars:
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: REDIS_URL
        fromService:
          name: sara-ai-core-redis
          type: keyvalue
          property: connectionString

  # --------------------------------------------------------
  # Celery Worker (Background Task Processor)
  # --------------------------------------------------------
  - type: worker
    name: sara-ai-core-worker
    env: python
    plan: standard
    region: oregon
    autoDeploy: true
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A sara_ai.celery_app worker --loglevel=info

    envVars:
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: REDIS_URL
        fromService:
          name: sara-ai-core-redis
          type: keyvalue
          property: connectionString

  # --------------------------------------------------------
  # Streaming Server (Twilio Media Stream Gateway)
  # --------------------------------------------------------
  - type: web
    name: sara-ai-core-streaming
    env: python
    plan: standard
    region: oregon
    autoDeploy: true
    buildCommand: pip install -r requirements.txt
    startCommand: python -m sara_ai.streaming_server
    healthCheckPath: /health

    envVars:
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: REDIS_URL
        fromService:
          name: sara-ai-core-redis
          type: keyvalue
          property: connectionString

# --------------------------------------------------------
# Redis (Central Key-Value Broker)
# --------------------------------------------------------
databases:
  - name: sara-ai-core-redis
    plan: standard
    region: oregon
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []
